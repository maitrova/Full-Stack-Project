name: Build → Push → Deploy (Compose, immutable tag)

on:
  push:
    branches: [ develop ]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get latest image tag
        id: get_tag
        run: |
          IMAGE=${{ secrets.IMAGE_NAME }}
          echo "Checking latest tags for $IMAGE..."
          
          # Use skopeo to list tags from remote registry (no pull needed)
          TAGS=$(skopeo list-tags docker://${IMAGE} 2>/dev/null | jq -r '.Tags[]' | grep -oP '(?<=-v)\d+' | sort -n)
          
          if [ -z "$TAGS" ]; then
            NEW_NUM=1
            echo "No existing version tags found, starting with v1"
          else
            LAST_NUM=$(echo "$TAGS" | tail -n 1)
            NEW_NUM=$((LAST_NUM + 1))
            echo "Found tags with versions, highest: v${LAST_NUM}"
            echo "Next version: v${NEW_NUM}"
          fi
          
          echo "tag=v${NEW_NUM}" >> $GITHUB_OUTPUT

      - name: Build frontend and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.IMAGE_NAME }}:frontend
            ${{ secrets.IMAGE_NAME }}:f-${{ steps.get_tag.outputs.tag }}
          build-args: |
            VITE_API_URL=/api/auth
      
      - name: Build backend and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ secrets.IMAGE_NAME }}:backend
            ${{ secrets.IMAGE_NAME }}:b-${{ steps.get_tag.outputs.tag }}
            
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: SSH to VPS and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "Executing Docker compose down"
            docker-compose down
            echo "Sleeping for 15 sec"
            sleep 15
            echo "Executing Docker compose pull"
            docker-compose pull
            echo "Executing Docker compose up"
            docker-compose up -d